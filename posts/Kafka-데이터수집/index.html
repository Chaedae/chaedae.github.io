<!DOCTYPE html><html lang="en-US" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Kafka 데이터 연동" /><meta name="author" content="ChaeDae" /><meta property="og:locale" content="en_US" /><meta name="description" content="Python 으로 Kafka 데이터를 연동하는 프로젝트를 진행했다." /><meta property="og:description" content="Python 으로 Kafka 데이터를 연동하는 프로젝트를 진행했다." /><link rel="canonical" href="https://chaedae.github.io/posts/Kafka-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%88%98%EC%A7%91/" /><meta property="og:url" content="https://chaedae.github.io/posts/Kafka-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%88%98%EC%A7%91/" /><meta property="og:site_name" content="ChaeDae" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-01T17:12:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Kafka 데이터 연동" /><meta name="twitter:site" content="@chaedae" /><meta name="twitter:creator" content="@ChaeDae" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"ChaeDae"},"description":"Python 으로 Kafka 데이터를 연동하는 프로젝트를 진행했다.","headline":"Kafka 데이터 연동","dateModified":"2022-08-01T17:12:00+09:00","datePublished":"2022-08-01T17:12:00+09:00","url":"https://chaedae.github.io/posts/Kafka-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%88%98%EC%A7%91/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://chaedae.github.io/posts/Kafka-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%88%98%EC%A7%91/"},"@context":"https://schema.org"}</script><title>Kafka 데이터 연동 | ChaeDae</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"> <script data-ad-client="ca-pub-3950494303914490" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.gif" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ChaeDae</a></div><div class="site-subtitle font-italic">Web Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/chaedae" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/daeyeong-chae-983290155" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['chaedae0','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Kafka 데이터 연동</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Kafka 데이터 연동</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> ChaeDae </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Aug 1, 2022, 5:12 PM +0900" prep="on" > Aug 1 <i class="unloaded">2022-08-01T17:12:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1092 words">6 min</span></div></div><div class="post-content"><p>Python 으로 Kafka 데이터를 연동하는 프로젝트를 진행했다.</p><h2 id="개발환경">개발환경</h2><hr /><p>서버에 설치되어 있는 파이썬이 구버전이었는데 버전을 올려서 하기가 어려운 상황이라 그냥 진행했다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre> Python: 2.7
 Kafka-python: 2.0.2
 Elasticsearch: 6.8.2
</pre></table></code></div></div><h2 id="프로세스">프로세스</h2><hr /><p>프로세스는 심플하다. 데이터를 가져와서 가공한 후에 각각의 서버로 넣어주는 파이프 역할이었다.</p><ol><li>Kafka Data Poll -&gt; 전처리 -&gt; Kafka Producer 전송<li>Kafka Data Poll -&gt; 전처리 -&gt; ES 적재</ol><p>2개의 프로세스를 실시간으로 처리해야 해서 Thread 2개를 사용했다.</p><p>전처리 속도가 크게 문제되지 않는 수준이라 Thread를 사용했지만, <br /> 파이썬 속도 이슈가 있다면 multiprocessing 을 쓰는것도 하나의 방법일 것 같다.</p><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
</pre><td class="rouge-code"><pre><span class="c1"># -*- encoding:utf-8 -*-
</span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">loads</span>
<span class="kn">from</span> <span class="nn">json</span> <span class="kn">import</span> <span class="n">dumps</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">KafkaConsumer</span>
<span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">KafkaProducer</span>
<span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">TopicPartition</span>
<span class="kn">from</span> <span class="nn">elasticsearch</span> <span class="kn">import</span> <span class="n">Elasticsearch</span>

<span class="n">CONSUMER_SERVERS</span><span class="o">=</span><span class="p">[</span><span class="s">'127.0.0.1:9092'</span><span class="p">,</span> <span class="s">'127.0.0.2:9092'</span><span class="p">]</span>
<span class="n">PRODUCER_SERVERS</span><span class="o">=</span><span class="p">[</span><span class="s">'127.0.1.1:9092'</span><span class="p">,</span> <span class="s">'127.0.1.2:9092'</span><span class="p">]</span>
<span class="n">ELASTIC_SERVERS</span><span class="o">=</span><span class="p">[</span><span class="s">'http://127.0.0.1:9400'</span><span class="p">,</span><span class="s">'http://127.0.0.2:9400'</span><span class="p">]</span>

<span class="c1"># Consumer 생성
</span><span class="k">def</span> <span class="nf">create_consumer</span><span class="p">(</span><span class="n">group_id</span><span class="p">):</span>
    <span class="n">consumer</span> <span class="o">=</span> <span class="n">KafkaConsumer</span><span class="p">(</span>
                   <span class="n">bootstrap_servers</span><span class="o">=</span><span class="n">CONSUMER_SERVERS</span><span class="p">,</span>  <span class="c1"># 카프카 컨슈머 서버
</span>                   <span class="n">enable_auto_commit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="c1"># 오토커밋 여부 (수동 커밋할거라 false)
</span>                   <span class="n">group_id</span><span class="o">=</span><span class="n">group_id</span><span class="p">,</span> <span class="c1"># Group ID
</span>                   <span class="n">auto_offset_reset</span><span class="o">=</span><span class="s">'earliest'</span><span class="p">,</span> <span class="c1"># 데이터를 어디서부터 끌어올지 여부 (earliest: 제일 오래된 데이터부터 / lastest: 최신 데이터부터) 
</span>                   <span class="n">consumer_timeout_ms</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="c1"># 타임아웃 설정
</span>                   <span class="n">value_deserializer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">loads</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">))</span> <span class="c1"># 데이터 인코딩
</span>               <span class="p">)</span>
    <span class="k">return</span> <span class="n">consumer</span>

<span class="c1"># Producer 생성
</span><span class="k">def</span> <span class="nf">create_producer</span><span class="p">():</span>
    <span class="n">producer</span> <span class="o">=</span> <span class="n">KafkaProducer</span><span class="p">(</span>
                   <span class="n">bootstrap_servers</span><span class="o">=</span><span class="n">PRODUCER_SERVERS</span><span class="p">,</span> <span class="c1"># 카프카 프로듀서 서버
</span>                   <span class="n">acks</span><span class="o">=</span><span class="s">"all"</span><span class="p">,</span>   <span class="c1"># Kafka 프로듀서가 데이터를 받았는지 확인 (0: No, 1: Yes (Follower는 확인 X), all: Yes (Follower 포함 - 손실률이 제일 적음))
</span>                   <span class="n">value_serializer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dumps</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span> <span class="c1"># 데이터 인코딩
</span>               <span class="p">)</span>
    <span class="k">return</span> <span class="n">producer</span>

<span class="c1"># Elastic Search 생성
</span><span class="k">def</span> <span class="nf">create_elastic</span><span class="p">():</span>
    <span class="n">es</span> <span class="o">=</span> <span class="n">Elasticsearch</span><span class="p">(</span>
             <span class="n">ELASTIC_SERVERS</span><span class="p">,</span> 
             <span class="n">request_timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> 
             <span class="n">max_retries</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
             <span class="n">retry_on_timeout</span><span class="o">=</span><span class="bp">True</span>
         <span class="p">)</span>
    <span class="k">return</span> <span class="n">es</span>

<span class="c1"># Redis 데이터 가져오기
</span><span class="k">def</span> <span class="nf">get_redis</span><span class="p">(</span><span class="n">redis_key</span><span class="p">):</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">Redis</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s">'utf-8'</span><span class="p">,</span> <span class="n">decode_response</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">redis_key</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># Kafka -&gt; Kafka
</span><span class="k">def</span> <span class="nf">proc_kafka</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
    <span class="c1"># 컨슈머 생성
</span>    <span class="n">consumer</span> <span class="o">=</span> <span class="n">create_consumer</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
    <span class="c1"># 구독
</span>    <span class="n">consumer</span><span class="p">.</span><span class="n">subscribe</span><span class="p">([</span><span class="n">topic</span><span class="p">])</span>

    <span class="c1"># 프로듀서 생성
</span>    <span class="n">producer</span> <span class="o">=</span> <span class="n">create_producer</span><span class="p">()</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># 데이터 Poll
</span>        <span class="n">message</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">.</span><span class="n">poll</span><span class="p">()</span>

        <span class="c1"># 데이터가 없을 경우 30초 대기
</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="c1"># 전처리 성공여부 
</span>        <span class="n">check_bool</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">topic_partition</span><span class="p">,</span> <span class="n">records</span> <span class="ow">in</span> <span class="n">message</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Data 전처리
</span>                    <span class="n">data</span> <span class="o">=</span> <span class="n">record</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="s">'result'</span><span class="p">]</span>

                    <span class="c1"># Producer 전송
</span>                    <span class="n">producer</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">'토픽명'</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">producer</span><span class="p">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># 오류 발생 시 최종 offset 위치 저장
</span>                    <span class="n">consumer</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">TopicPartition</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">topic</span><span class="p">,</span> <span class="n">record</span><span class="p">.</span><span class="n">partition</span><span class="p">),</span> <span class="n">record</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
                    <span class="c1"># Log 출력 후 for문 종료
</span>                    <span class="n">check_bool</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">)</span> <span class="o">+</span> <span class="s">' Kafka -&gt; Kafka 데이터 연동 오류 발생'</span><span class="p">)</span>
                    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
                    <span class="k">break</span>
            
            <span class="c1"># 전처리 실패 시 데이터 다시 구독
</span>            <span class="k">if</span> <span class="n">check_bool</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
               <span class="k">break</span>
        
        <span class="c1"># 전처리 성공 시 Commit 후 다음 메시지 구독
</span>        <span class="k">if</span> <span class="n">check_bool</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">consumer</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>


<span class="c1"># Kafka -&gt; ES
</span><span class="k">def</span> <span class="nf">proc_es</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">group_id</span><span class="p">):</span>
    <span class="c1"># 컨슈머 생성
</span>    <span class="n">consumer</span> <span class="o">=</span> <span class="n">create_consumer</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>
    <span class="c1"># 구독
</span>    <span class="n">consumer</span><span class="p">.</span><span class="n">subscribe</span><span class="p">([</span><span class="n">topic</span><span class="p">])</span>

    <span class="c1"># Reids Data 가져오기
</span>    <span class="n">REDIS_DATA</span> <span class="o">=</span> <span class="n">get_redis</span><span class="p">(</span><span class="s">'redis_key'</span><span class="p">)</span>

    <span class="c1"># ES 생성
</span>    <span class="n">es</span> <span class="o">=</span> <span class="n">create_elastic</span><span class="p">()</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># 데이터 Poll
</span>        <span class="n">message</span> <span class="o">=</span> <span class="n">consumer</span><span class="p">.</span><span class="n">poll</span><span class="p">()</span>

        <span class="c1"># 데이터가 없을 경우 30초 대기
</span>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="c1"># 전처리 성공여부 
</span>        <span class="n">check_bool</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">topic_partition</span><span class="p">,</span> <span class="n">records</span> <span class="ow">in</span> <span class="n">message</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Data 전처리
</span>                    <span class="n">data</span> <span class="o">=</span> <span class="n">record</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="s">'result'</span><span class="p">]</span>

                    <span class="c1"># ES 입력
</span>                    <span class="n">es</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s">'인덱스명'</span><span class="p">,</span> <span class="n">doc_type</span><span class="o">=</span><span class="s">'itmes'</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">키값</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s">'doc'</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s">'doc_as_upsert'</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># 오류 발생 시 최종 offset 위치 저장
</span>                    <span class="n">consumer</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">TopicPartition</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">topic</span><span class="p">,</span> <span class="n">record</span><span class="p">.</span><span class="n">partition</span><span class="p">),</span> <span class="n">record</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
                    <span class="c1"># Log 출력 후 for문 종료
</span>                    <span class="n">check_bool</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">().</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%Y-%m-%d %H:%M:%S"</span><span class="p">)</span> <span class="o">+</span> <span class="s">' Kafka -&gt; ES 데이터 연동 오류 발생'</span><span class="p">)</span>
                    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
                    <span class="k">break</span>
            
            <span class="c1"># 전처리 실패 시 데이터 다시 구독
</span>            <span class="k">if</span> <span class="n">check_bool</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
               <span class="k">break</span>
        
        <span class="c1"># 전처리 성공 시 Commit 후 다음 메시지 구독
</span>        <span class="k">if</span> <span class="n">check_bool</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">consumer</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">th1</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">proc_kafka</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">'토픽명1'</span><span class="p">,</span> <span class="s">'그룹ID'</span><span class="p">))</span>
    <span class="n">th2</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">proc_es</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s">'토픽명2'</span><span class="p">,</span> <span class="s">'그룹ID'</span><span class="p">))</span>

    <span class="n">th1</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">th2</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    
    <span class="n">th1</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">th2</span><span class="p">.</span><span class="n">join</span><span class="p">()</span>


</pre></table></code></div></div><p>python 으로 만들긴 했지만 일반적으로는 java를 많이 사용하는 듯 하다.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/python/'>Python</a>, <a href='/categories/bigdata/'>BigData</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/python/" class="post-tag no-text-decoration" >python</a> <a href="/tags/kafka/" class="post-tag no-text-decoration" >kafka</a> <a href="/tags/%ED%8C%8C%EC%9D%B4%EC%8D%AC/" class="post-tag no-text-decoration" >파이썬</a> <a href="/tags/%EC%B9%B4%ED%94%84%EC%B9%B4/" class="post-tag no-text-decoration" >카프카</a> <a href="/tags/consumer/" class="post-tag no-text-decoration" >consumer</a> <a href="/tags/producer/" class="post-tag no-text-decoration" >producer</a> <a href="/tags/es/" class="post-tag no-text-decoration" >ES</a> <a href="/tags/elasticsearch/" class="post-tag no-text-decoration" >elasticsearch</a> <a href="/tags/redis/" class="post-tag no-text-decoration" >redis</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Kafka 데이터 연동 - ChaeDae&url=https://chaedae.github.io/posts/Kafka-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%88%98%EC%A7%91/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Kafka 데이터 연동 - ChaeDae&u=https://chaedae.github.io/posts/Kafka-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%88%98%EC%A7%91/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Kafka 데이터 연동 - ChaeDae&url=https://chaedae.github.io/posts/Kafka-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%88%98%EC%A7%91/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/SpringBoot+H2-RestAPI-%EC%97%B0%EC%8A%B5/">Spring Boot + H2 Rest API</a><li><a href="/posts/Rest-API%EC%97%90-Swagger-%EC%A0%81%EC%9A%A9%ED%95%98%EA%B8%B0/">RestAPI에 Swagger 적용하기</a><li><a href="/posts/XML-%ED%8C%8C%EC%8B%B1/">XML 파싱</a><li><a href="/posts/Log4j-%EB%A1%9C%EA%B7%B8%ED%8C%8C%EC%9D%BC-%EB%B6%84%EB%A6%AC/">Log4j 로그파일 분리</a><li><a href="/posts/Logger-2%EA%B0%9C-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0/">Logger 2개 사용하기</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/gradle/">Gradle</a> <a class="post-tag" href="/tags/%ED%99%98%EA%B2%BD%EC%84%A4%EC%A0%95/">환경설정</a> <a class="post-tag" href="/tags/api/">API</a> <a class="post-tag" href="/tags/log/">Log</a> <a class="post-tag" href="/tags/hive/">hive</a> <a class="post-tag" href="/tags/log4j/">log4j</a> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/rest/">rest</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Python-PyHive/"><div class="card-body"> <span class="timeago small" > Dec 1, 2021 <i class="unloaded">2021-12-01T17:42:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python PyHive</h3><div class="text-muted small"><p> PyHive 파이썬에서 hive로 접속해서 쿼리를 할 수 있게 도와주는 라이브러리다. pyhive 라이브러리는 Kerberos 프로토콜을 이용해서 python &lt;-&gt; hive 통신을 하기 때문에, 이와 관련된 라이브러리를 설치해줘야 한다. 설치 pip install sasl (인증 및 데이터보안) pip install thrift (...</p></div></div></a></div><div class="card"> <a href="/posts/Python-%ED%86%A0%ED%94%BD%EB%AA%A8%EB%8D%B8%EB%A7%81/"><div class="card-body"> <span class="timeago small" > Dec 13, 2021 <i class="unloaded">2021-12-13T17:42:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Python 토픽 모델링</h3><div class="text-muted small"><p> 파이썬의 Gensim 라이브러리를 이용해서 토픽을 추출하는 프로젝트를 진행했다. 처음으로 파이썬으로 개발을 진행한 프로젝트라 기록을 남겨둔다. 데이터 1. 상품 및 유형 데이터 (2x3) 2. 하루 치 상담 데이터 (상품 및 유형 정보 포함) 3. 중복제거 된 상담사 데이터 4. 한국 지역 및 장소,지명 데이터 위의 데이터로 각 상품 &am...</p></div></div></a></div><div class="card"> <a href="/posts/%EB%AA%85%EB%A0%B9%EC%96%B4-%EB%AA%A8%EC%9D%8C/"><div class="card-body"> <span class="timeago small" > Aug 18 <i class="unloaded">2022-08-18T16:38:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>운영 시 유용한 명령어 모음</h3><div class="text-muted small"><p> 서버 운영을 하면서 자주 쓰이거나 자주 까먹는 명령어를 정리해봤다. 계속해서 업데이트 할 예정이다. LINUX 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # 용량 확인 서버전체: df -h 특정폴더: du -sh /경로 iNode: df -i # 파일 분할 용량기준: split -b 10...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Python-%ED%86%A0%ED%94%BD%EB%AA%A8%EB%8D%B8%EB%A7%81/" class="btn btn-outline-primary" prompt="Older"><p>Python 토픽 모델링</p></a> <a href="/posts/%EB%AA%85%EB%A0%B9%EC%96%B4-%EB%AA%A8%EC%9D%8C/" class="btn btn-outline-primary" prompt="Newer"><p>운영 시 유용한 명령어 모음</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//chaedae.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Kafka 데이터 연동'; this.page.url = 'https://chaedae.github.io/posts/Kafka-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%88%98%EC%A7%91/'; this.page.identifier = '/posts/Kafka-%EB%8D%B0%EC%9D%B4%ED%84%B0%EC%88%98%EC%A7%91/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/chaedae">chaedae</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/gradle/">Gradle</a> <a class="post-tag" href="/tags/%ED%99%98%EA%B2%BD%EC%84%A4%EC%A0%95/">환경설정</a> <a class="post-tag" href="/tags/api/">API</a> <a class="post-tag" href="/tags/log/">Log</a> <a class="post-tag" href="/tags/hive/">hive</a> <a class="post-tag" href="/tags/log4j/">log4j</a> <a class="post-tag" href="/tags/python/">Python</a> <a class="post-tag" href="/tags/rest/">rest</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://chaedae.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
